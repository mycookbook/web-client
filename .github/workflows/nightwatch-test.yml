name: Nightwatch Tests

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Nightwatch Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14.x  # Use a compatible Node.js version

      - name: Install Dependencies
        run: npm install

      - name: Get Chrome Version
        id: chrome_version
        run: echo ::set-output name=version::$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)

      - name: Install Chromedriver
        run: |
          LATEST_CHROMEDRIVER_VERSION=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE)
          echo "Latest ChromeDriver version: $LATEST_CHROMEDRIVER_VERSION"
          CHROME_VERSION=${{ steps.chrome_version.outputs.version }}
          echo "Chrome version on runner: $CHROME_VERSION"
          if [ "$CHROME_VERSION" -gt "$LATEST_CHROMEDRIVER_VERSION" ]; then
            # Download a compatible ChromeDriver version
            CHROMEDRIVER_URL="http://chromedriver.storage.googleapis.com/$CHROME_VERSION.0/chromedriver_linux64.zip"
            curl -o chromedriver_linux64.zip "$CHROMEDRIVER_URL"
            unzip chromedriver_linux64.zip
            chmod +x chromedriver
            sudo mv chromedriver /usr/local/bin/
          fi

      - name: Run Nightwatch tests
        run: npm run e2e

      - name: Upload coverage results
        uses: actions/upload-artifact@v2
        with:
          name: coverage
          path: coverage
